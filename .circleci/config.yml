version: 2
jobs:
  build:
    docker:
      - image: sicz/dockerspec:17.04.24
    working_directory: ~/docker-lighttpd
    environment:
      - MAKEFLAGS=--no-print-directory
    steps:
      - run:
          name: Set up Environment
          command: |
            apk update
            apk add --no-progress git make openssh-client
            curl -sSL https://github.com/SICZ/Mk/archive/master.tar.gz | tar -xzf -
            mv Mk-master ~/Mk
      - checkout
      - setup_remote_docker
      - run:
          name: Remote Docker engine version
          command: |
            docker version
      - run:
          name: Build Docker image
          command: |
            make rebuild
      - run:
          name: Run Docker container
          command: |
            make run
            make logs
      - run:
          name: Run tests
          command: |
            docker cp spec/fixtures/www `cat .container_id`:/var
            env DOCKER_CONTAINER_ID=$(cat .container_id) rspec --format doc
